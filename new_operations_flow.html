<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advertiser to User Flow</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            line-height: 1.6;
            padding: 20px;
            color: #333;
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 { color: #2c3e50; }
        #flowchart {
            width: 100%;
            height: 80vh;
            position: relative;
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            grid-template-rows: repeat(4, 1fr);
            gap: 20px;
            padding: 20px;
        }
        .bento-box {
            border-radius: 10px;
            padding: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            border: 1px solid #000000;
            transition: all 0.3s ease;
            font-family: 'Inter', sans-serif;
            font-size: 16px;
            font-weight: 600;
            text-align: center;
        }
        .bento-box:hover {
            box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.2);
            transform: scale(1.05);
        }
        .subgraph {
            border: 2px dashed #666;
            border-radius: 15px;
            padding: 10px;
            display: flex;
            flex-direction: column;
            justify-content: space-around;
            align-items: center;
        }
        .subgraph-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 10px;
        }
        .back-link {
            font-family: Inter, sans-serif;
            font-size: 16px;
            color: #3498db;
            text-decoration: none;
            position: relative;
            transition: transform 0.3s ease;
            display: inline-block;
        }
        .back-link:before {
            content: "\2190";
            margin-right: 5px;
        }
        .back-link:hover {
            transform: scale(1.05);
        }
    </style>
</head>
<body>
    <a href="#" class="back-link" onclick="goBackToInframap(); return false;">Back to Infrastructure Map</a>
    <h1>Advertiser to User Flow</h1>
    <div id="flowchart"></div>
    <script>
        function goBackToInframap() {
            if (window.parent !== window.self) {
                window.parent.postMessage({ action: 'navigateToInframap' }, '*');
            } else {
                window.location.href = 'index.html#infra';
            }
        }
        
        const bentoBoxes = [
            { id: 'advertisers', label: 'ADVERTISERS', color: '#ffffff', gridArea: '1 / 1 / 5 / 2' },
            { id: 'salesforce', label: 'SALESFORCE', color: '#f2f2f7', gridArea: '1 / 2 / 2 / 3' },
            { id: 'programmatic', label: 'PROGRAMMATIC', color: '#e8f3ec', gridArea: '2 / 2 / 3 / 3' },
            { id: 'mosaic', label: 'MOSAIC', color: '#fef5ea', gridArea: '3 / 2 / 4 / 3' },
            { id: 'beeswax', label: 'BEESWAX', color: '#e5f8ff', gridArea: '1 / 3 / 2 / 4' },
            { id: 'peregrine', label: 'PEREGRINE', color: '#e5f8ff', gridArea: '2 / 3 / 3 / 4' },
            { id: 'tools', label: 'TOOLS', color: '#f2f2f7', gridArea: '3 / 3 / 4 / 4' },
            { id: 'data', label: 'DATA', color: '#f2f2f7', gridArea: '4 / 3 / 5 / 4' },
            { id: 'ssp', label: 'SSP/AD EXCHANGE', color: '#e8f3ec', gridArea: '1 / 4 / 5 / 5' },
            { id: 'publisher', label: 'PUBLISHER', color: '#fef5ea', gridArea: '1 / 5 / 5 / 6' },
            { id: 'user', label: 'USER', color: '#ffffff', gridArea: '1 / 6 / 5 / 7' },
        ];

        const flowchart = document.getElementById('flowchart');

        // Create subgraphs
        const campaignManagement = document.createElement('div');
        campaignManagement.className = 'subgraph';
        campaignManagement.style.gridArea = '1 / 2 / 5 / 4';
        campaignManagement.innerHTML = '<div class="subgraph-title">Campaign Management</div>';
        flowchart.appendChild(campaignManagement);

        const dsp = document.createElement('div');
        dsp.className = 'subgraph';
        dsp.style.gridArea = '1 / 3 / 3 / 4';
        dsp.innerHTML = '<div class="subgraph-title">DSP</div>';
        campaignManagement.appendChild(dsp);

        bentoBoxes.forEach(box => {
            const div = document.createElement('div');
            div.id = box.id;
            div.className = 'bento-box';
            div.style.backgroundColor = box.color;
            div.style.gridArea = box.gridArea;
            div.textContent = box.label;
            
            if (['salesforce', 'programmatic', 'mosaic', 'tools', 'data'].includes(box.id)) {
                campaignManagement.appendChild(div);
            } else if (['beeswax', 'peregrine'].includes(box.id)) {
                dsp.appendChild(div);
            } else {
                flowchart.appendChild(div);
            }
        });

        const arrows = [
            { from: 'advertisers', to: 'salesforce', label: 'IO' },
            { from: 'programmatic', to: 'salesforce' },
            { from: 'salesforce', to: 'mosaic' },
            { from: 'mosaic', to: 'beeswax' },
            { from: 'beeswax', to: 'mosaic' },
            { from: 'mosaic', to: 'peregrine' },
            { from: 'peregrine', to: 'mosaic' },
            { from: 'mosaic', to: 'ssp' },
            { from: 'ssp', to: 'publisher' },
            { from: 'publisher', to: 'user' },
        ];

        function createArrow(from, to, label) {
            const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
            svg.style.position = 'absolute';
            svg.style.top = '0';
            svg.style.left = '0';
            svg.style.width = '100%';
            svg.style.height = '100%';
            svg.style.pointerEvents = 'none';
            
            const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
            path.setAttribute('stroke', '#000000');
            path.setAttribute('stroke-width', '2');
            path.setAttribute('fill', 'none');
            path.setAttribute('marker-end', 'url(#arrowhead)');
            
            const arrowhead = document.createElementNS("http://www.w3.org/2000/svg", "marker");
            arrowhead.setAttribute('id', 'arrowhead');
            arrowhead.setAttribute('markerWidth', '10');
            arrowhead.setAttribute('markerHeight', '7');
            arrowhead.setAttribute('refX', '9');
            arrowhead.setAttribute('refY', '3.5');
            arrowhead.setAttribute('orient', 'auto');

            const polygon = document.createElementNS("http://www.w3.org/2000/svg", "polygon");
            polygon.setAttribute('points', '0 0, 10 3.5, 0 7');
            polygon.setAttribute('fill', '#000000');

            arrowhead.appendChild(polygon);
            svg.appendChild(arrowhead);
            svg.appendChild(path);

            if (label) {
                const text = document.createElementNS("http://www.w3.org/2000/svg", "text");
                text.setAttribute('fill', '#000000');
                text.setAttribute('font-size', '12');
                text.textContent = label;
                svg.appendChild(text);
            }

            flowchart.appendChild(svg);

            return { path, text };
        }

        arrows.forEach(arrow => {
            const { path, text } = createArrow(arrow.from, arrow.to, arrow.label);

            const updateArrow = () => {
                const fromElement = document.getElementById(arrow.from);
                const toElement = document.getElementById(arrow.to);
                if (fromElement && toElement) {
                    const fromRect = fromElement.getBoundingClientRect();
                    const toRect = toElement.getBoundingClientRect();
                    const flowchartRect = flowchart.getBoundingClientRect();

                    const fromX = fromRect.left + fromRect.width / 2 - flowchartRect.left;
                    const fromY = fromRect.top + fromRect.height / 2 - flowchartRect.top;
                    const toX = toRect.left + toRect.width / 2 - flowchartRect.left;
                    const toY = toRect.top + toRect.height / 2 - flowchartRect.top;

                    path.setAttribute('d', `M${fromX},${fromY} L${toX},${toY}`);

                    if (text) {
                        const midX = (fromX + toX) / 2;
                        const midY = (fromY + toY) / 2;
                        text.setAttribute('x', midX);
                        text.setAttribute('y', midY);
                    }
                }
            };

            updateArrow();
            window.addEventListener('resize', updateArrow);
        });
    </script>
</body>
</html>
