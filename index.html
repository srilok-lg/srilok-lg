import React, { useState, useEffect } from 'react';
import { ChevronRight } from 'lucide-react';
import { Switch } from './Switch'; // Assuming Switch component is in the same directory

const bentoBoxes = {
    operations: [
        { id: 'advertisers', label: 'Advertisers', color: '#ffffff', next: [{ to: 'mediaPlanning', label: 'Outreach/RFP' }], gridArea: '1 / 1 / 2 / 2' },
        { id: 'mediaPlanning', label: 'Media Planning', color: '#f2f2f7', next: [{ to: 'campaignManagement', label: 'Closed Won' }], gridArea: '2 / 1 / 3 / 2' },
        // ... rest of the operations
    ],
    infra: [
        { id: 'salesforce', label: 'Salesforce', color: '#ffffff', next: [{ to: 'campaignParameters', label: '' }], gridArea: '1 / 1 / 2 / 2' },
        { id: 'campaignParameters', label: 'Campaign Parameters', color: '#f2f2f7', next: [], gridArea: '2 / 2 / 3 / 3' },
        // ... rest of the infra
    ]
};

const BentoBox = ({ id, label, color, isHovered, onHover, onClick, gridArea }) => {
    return (
        <div
        id={id}
        className="rounded-lg p-4 flex justify-center items-center shadow-sm hover:shadow-md transition-all duration-300 border border-gray-200 cursor-pointer z-10"
        style={{
        backgroundColor: color,
        transform: isHovered ? 'scale(1.05)' : 'scale(1)',
        gridArea: gridArea,
        }}
        onMouseEnter={() => onHover(id)}
        onMouseLeave={() => onHover(null)}
        onClick={() => onClick(id)}>
        <span className="text-gray-800 font-medium text-center">
          {label}
        </span>
      </div>
    );
  };

const Arrow = ({ start, end, label, bidirectional }) => {
  const [path, setPath] = useState('');
  const [labelPosition, setLabelPosition] = useState({ x: 0, y: 0 });

  useEffect(() => {
    const updateArrow = () => {
      const startElement = document.getElementById(start);
      const endElement = document.getElementById(end);
      if (startElement && endElement) {
        const startRect = startElement.getBoundingClientRect();
        const endRect = endElement.getBoundingClientRect();
        
        const startX = startRect.left + startRect.width / 2;
        const startY = startRect.top + startRect.height / 2;
        const endX = endRect.left + endRect.width / 2;
        const endY = endRect.top + endRect.height / 2;
        
        const angle = Math.atan2(endY - startY, endX - startX);
        
        const startRadius = Math.min(startRect.width, startRect.height) / 2;
        const endRadius = Math.min(endRect.width, endRect.height) / 2;
        const newStartX = startX + Math.cos(angle) * startRadius;
        const newStartY = startY + Math.sin(angle) * startRadius;
        const newEndX = endX - Math.cos(angle) * endRadius;
        const newEndY = endY - Math.sin(angle) * endRadius;
        
        const midX = (newStartX + newEndX) / 2;
        const midY = (newStartY + newEndY) / 2;
        const curveFactor = 0.2;
        const curveX = midX + (newEndY - newStartY) * curveFactor;
        const curveY = midY - (newEndX - newStartX) * curveFactor;
        
        setPath(`M${newStartX},${newStartY} Q${curveX},${curveY} ${newEndX},${newEndY}`);
        setLabelPosition({
          x: curveX,
          y: curveY
        });
      }
    };

    updateArrow();
    window.addEventListener('resize', updateArrow);
    return () => window.removeEventListener('resize', updateArrow);
  }, [start, end]);

  return (
    <g>
      <defs>
        <marker id={`arrowhead-${start}-${end}`} markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
          <polygon points="0 0, 10 3.5, 0 7" fill="#000000" />
        </marker>
        {bidirectional && (
          <marker id={`arrowhead-start-${start}-${end}`} markerWidth="10" markerHeight="7" refX="0" refY="3.5" orient="auto">
            <polygon points="10 0, 0 3.5, 10 7" fill="#000000" />
          </marker>
        )}
      </defs>
      <path 
        d={path} 
        stroke="#000000" 
        strokeWidth="2" 
        fill="none" 
        markerEnd={`url(#arrowhead-${start}-${end})`}
        markerStart={bidirectional ? `url(#arrowhead-start-${start}-${end})` : ""}
      />
      <text x={labelPosition.x} y={labelPosition.y} textAnchor="middle" fill="#36454F" fontSize="12px">
        {label}
      </text>
    </g>
  );
};

const BentoFlowchart = () => {
  const [currentGraph, setCurrentGraph] = useState('operations');
  const [hoveredBox, setHoveredBox] = useState(null);

  const handleBoxClick = (id) => {
    window.location.href = `${id}.html`;
  };

  const toggleGraph = () => {
    setCurrentGraph(currentGraph === 'operations' ? 'infra' : 'operations');
  };

  useEffect(() => {
    const handleHashChange = () => {
      if (window.location.hash === '#infra') {
        setCurrentGraph('infra');
      }
    };

    window.addEventListener('load', handleHashChange);
    window.addEventListener('hashchange', handleHashChange);

    return () => {
      window.removeEventListener('load', handleHashChange);
      window.removeEventListener('hashchange', handleHashChange);
    };
  }, []);

  return (
    <div className="p-4 max-w-7xl mx-auto">
      <h1 className="text-2xl font-bold text-gray-800 mb-4">
        {currentGraph === 'operations' ? 'Operations Flow' : 'Infrastructure Map'}
      </h1>
      <div className="flex items-center mb-4">
        <Switch id="graphToggle" onCheckedChange={toggleGraph} />
        <label htmlFor="graphToggle" className="ml-2">
          Switch to {currentGraph === 'operations' ? 'Infrastructure Map' : 'Operations Flow'}
        </label>
      </div>
      <div className="relative" style={{
        display: 'grid',
        gridTemplateColumns: 'repeat(4, 1fr)',
        gridTemplateRows: currentGraph === 'operations' ? 'repeat(5, 1fr)' : 'repeat(8, 1fr)',
        gap: '1rem',
        height: currentGraph === 'operations' ? '600px' : '1000px'
      }}>
        <svg className="absolute top-0 left-0 w-full h-full" style={{zIndex: 0}}>
          {Object.values(bentoBoxes[currentGraph]).flatMap(box => 
            box.next.map(({ to, label, bidirectional }) => (
              <Arrow key={`${box.id}-${to}`} start={box.id} end={to} label={label} bidirectional={bidirectional} />
            ))
          )}
        </svg>
        {Object.values(bentoBoxes[currentGraph]).map((box) => (
          <BentoBox
            key={box.id}
            {...box}
            isHovered={hoveredBox === box.id}
            onHover={setHoveredBox}
            onClick={handleBoxClick}
          />
        ))}
      </div>
    </div>
  );
};

export default BentoFlowchart;